# 编写Web Server 测试

### Main Target

+ 测试的讨论与思考
+ REST接口单元测试实践
+ 基准测试和压力测试



## 01. 测试的讨论与思考



#### 为什么要写测试

+ 编写测试代码的时间远比编写代码时间更长
+ 更多的测试代码代表着更多bug的出现概率
+ 测试代码的组织和维护缺乏工具和框架，手动维护成本高
+ 基于测试的思路容易走向系统的过度设计，关注点脱离主流



#### 测试的道理

+ 测试的价值母庸质疑，但要划清界限，哪些要测试？
+ TDD只适合重构自己代码的场景，不要盲目尝试
+ 不要着急实现测试细节，只关注输入输出
+ 挑选适合的测试框架，避免做无意义的“编程卡顿”
+ 添加测试的目的还是为了保障你能够编写高质量的代码



#### 测试的最佳实践FIRST

1. Fast
   1. 测试代码必须能够快速执行
2. Independent
   1. 不依赖环境和顺序，有自己的3A环节
3. Repeatable
   1. 测试代码执行1次和执行多次的结果相同
4. Self-Valid
   1. 测试要给出结果，是否通过



**Thorough：测试尽量覆盖所有应用场景**



## 02. REST接口单元测试实践

### 搭建测试环境

+ 在ava/mocha/jasmine/tap 中选一个框架，这里选 Mocha
+ 使用supertest 作为客户端代理，向服务发起 request 请求
+ 引入 chai 断言库， 配合mocha 编写 单测
+ 在钩子中初始化服务器环境，重置数据库数据，处理掉require缓存

```js
beforeEach(function() {
    delete require.cache[require.resolve('./server')]
    server = require('./server')
})
```



## 03. 基准测试与压力测试

### 关注服务性能

+ 使用 benchmark 对核心代码进行基准测试
+ 根据服务业务场景和经验估算业务访问量 PV
+ 使用 ab 对服务的吞吐率、响应时间、并发数进行测试
  + 响应时间：系统对请求进行处理并作出响应的时间
  + 吞吐量：系统在单位时间内处理请求的数量，响应时间的倒数
  + 并发用户数：系统可以同时承载的正常使用系统功能的用户的数量